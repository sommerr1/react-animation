import React, { Suspense, useRef, useState, useEffect } from 'react';
import { Canvas, useFrame, useThree } from '@react-three/fiber';
import { OrbitControls, Environment, useGLTF, useAnimations } from '@react-three/drei';
import * as THREE from 'three';
import { useDispatch, useSelector } from 'react-redux';
import { RootState } from '../store/store';
import { setStatistics } from '../store/modelSlice';
import { calculateModelStatistics } from '../utils/modelStatistics';
import AnimationControls from './AnimationControls';
import ModelStatisticsDisplay from './ModelStatistics';
import { useAnimation } from '../contexts/AnimationContext';
import { useUI } from '../contexts/UIContext';

interface ModelViewerProps {
  modelPath: string;
  scale?: number;
  position?: [number, number, number];
  isNodding?: boolean;
  setIsNodding?: React.Dispatch<React.SetStateAction<boolean>>;
  selectedMaterialName?: string | null;
  onMaterialsFound?: (materials: string[]) => void;
}

function Model({ modelPath, scale = 1, position = [0, 0, 0], isNodding, setIsNodding, isShaking, setIsShaking, selectedMaterialName, onMaterialsFound }: ModelViewerProps & { isShaking?: boolean; setIsShaking?: React.Dispatch<React.SetStateAction<boolean>>; selectedMaterialName?: string | null; onMaterialsFound?: (materials: string[]) => void }) {
  const { scene, animations, materials: gltfMaterials } = useGLTF(modelPath);
  const groupRef = useRef<THREE.Group>(null);
  const { actions, names } = useAnimations(animations, groupRef);
  const { setAnimations, setCurrentAnimation, currentAnimation, isPlaying, mousePosition } = useAnimation();
  const dispatch = useDispatch();
  const { invalidate } = useThree(); // –î–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–µ–Ω–¥–µ—Ä–∞
  const nodState = useRef({ direction: 1, angle: 0, count: 0, target: 2 }); // target: —Å–∫–æ–ª—å–∫–æ –∫–∏–≤–∫–æ–≤ —Å–¥–µ–ª–∞—Ç—å
  const shakeState = useRef({ direction: 1, angle: 0, count: 0, target: 2 });
  const materialsRef = useRef<Map<string, THREE.Material>>(new Map());
  const originalMaterialsRef = useRef<Map<THREE.Mesh, THREE.Material | THREE.Material[]>>(new Map());
  // –•—Ä–∞–Ω–∏–º —Å–ø–∏—Å–æ–∫ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –±—ã–ª–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã –∫–∞–∂–¥–æ–º—É –º–µ—à—É
  const meshMaterialsMap = useRef<Map<THREE.Mesh, Set<string>>>(new Map());

  // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏–∑ —Å—Ü–µ–Ω—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  useEffect(() => {
    if (scene) {
      materialsRef.current.clear();
      originalMaterialsRef.current.clear();
      const materialNames: string[] = [];
      const allMaterials = new Set<string>();
      
      console.log('[ModelViewer] –ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∏–∑ —Å—Ü–µ–Ω—ã...');
      
      // –°–Ω–∞—á–∞–ª–∞ —Å–æ–±–∏—Ä–∞–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏–∑ GLTF –Ω–∞–ø—Ä—è–º—É—é (–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∏–∑ —Ñ–∞–π–ª–∞)
      // –≠—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤, —Ç–∞–∫ –∫–∞–∫ –æ–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏–∑ GLB —Ñ–∞–π–ª–∞
      if (gltfMaterials && Array.isArray(gltfMaterials)) {
        console.log(`[ModelViewer] GLTF –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏–∑ useGLTF: ${gltfMaterials.length} —à—Ç—É–∫`);
        gltfMaterials.forEach((mat, idx) => {
          // –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –º–∞—Ç–µ—Ä–∏–∞–ª—ã —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∏–º–µ–Ω–∞–º–∏
          // –ú–∞—Ç–µ—Ä–∏–∞–ª—ã –±–µ–∑ –∏–º–µ–Ω–∏ –∏–ª–∏ —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –∏–º–µ–Ω–∞–º–∏ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
          const materialName = mat.name;
          
          // –§–∏–ª—å—Ç—Ä—É–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª—ã –±–µ–∑ –∏–º–µ–Ω–∏ –∏–ª–∏ —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –∏–º–µ–Ω–∞–º–∏
          if (!materialName || materialName.trim() === '') {
            console.log(`[ModelViewer] ‚äò GLTF –ú–∞—Ç–µ—Ä–∏–∞–ª [${idx}] –ø—Ä–æ–ø—É—â–µ–Ω (–Ω–µ—Ç –∏–º–µ–Ω–∏): type="${mat.type}"`);
            return;
          }
          
          // –§–∏–ª—å—Ç—Ä—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∏–º–µ–Ω–∞ (Material_0, Material_1, –ú–∞—Ç–µ—Ä–∏–∞–ª 1, Material 2, etc.)
          const defaultNamePatterns = [
            /^Material_\d+$/i,           // Material_0, Material_1, etc.
            /^–ú–∞—Ç–µ—Ä–∏–∞–ª\s*\d+$/i,         // –ú–∞—Ç–µ—Ä–∏–∞–ª 1, –ú–∞—Ç–µ—Ä–∏–∞–ª 2, etc.
            /^Material\s*\d+$/i,         // Material 1, Material 2, etc.
            /^GLTF_Material_\d+$/i,      // GLTF_Material_0, etc.
            /^Material$/i,                // –ü—Ä–æ—Å—Ç–æ "Material"
            /^–ú–∞—Ç–µ—Ä–∏–∞–ª$/i                 // –ü—Ä–æ—Å—Ç–æ "–ú–∞—Ç–µ—Ä–∏–∞–ª"
          ];
          
          const isDefaultName = defaultNamePatterns.some(pattern => pattern.test(materialName));
          if (isDefaultName) {
            console.log(`[ModelViewer] ‚äò GLTF –ú–∞—Ç–µ—Ä–∏–∞–ª [${idx}] –ø—Ä–æ–ø—É—â–µ–Ω (–¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∏–º—è): "${materialName}"`);
            return;
          }
          
          console.log(`[ModelViewer] GLTF –ú–∞—Ç–µ—Ä–∏–∞–ª [${idx}]: name="${materialName}", type="${mat.type}"`);
          
          if (!materialsRef.current.has(materialName)) {
            materialsRef.current.set(materialName, mat);
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ allMaterials —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø—Ä–∏ –æ–±—Ö–æ–¥–µ —Å—Ü–µ–Ω—ã
            allMaterials.add(materialName);
            if (!materialName.startsWith('__SINGLE__')) {
              materialNames.push(materialName);
              console.log(`[ModelViewer] ‚úì GLTF –ú–∞—Ç–µ—Ä–∏–∞–ª –¥–æ–±–∞–≤–ª–µ–Ω: "${materialName}"`);
            } else {
              console.log(`[ModelViewer] ‚äò GLTF –ú–∞—Ç–µ—Ä–∏–∞–ª –ø—Ä–æ–ø—É—â–µ–Ω (single): "${materialName}"`);
            }
          }
        });
      } else if (gltfMaterials) {
        console.log(`[ModelViewer] GLTF –º–∞—Ç–µ—Ä–∏–∞–ª—ã (–Ω–µ –º–∞—Å—Å–∏–≤):`, gltfMaterials);
        // –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ä–µ–∫—Ç, –∏—Ç–µ—Ä–∏—Ä—É–µ–º –ø–æ –Ω–µ–º—É
        Object.entries(gltfMaterials).forEach(([key, mat]) => {
          const material = mat as THREE.Material;
          const materialName = material.name;
          
          // –§–∏–ª—å—Ç—Ä—É–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª—ã –±–µ–∑ –∏–º–µ–Ω–∏ –∏–ª–∏ —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –∏–º–µ–Ω–∞–º–∏
          if (!materialName || materialName.trim() === '') {
            console.log(`[ModelViewer] ‚äò GLTF –ú–∞—Ç–µ—Ä–∏–∞–ª "${key}" –ø—Ä–æ–ø—É—â–µ–Ω (–Ω–µ—Ç –∏–º–µ–Ω–∏): type="${material.type}"`);
            return;
          }
          
          // –§–∏–ª—å—Ç—Ä—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∏–º–µ–Ω–∞
          const defaultNamePatterns = [
            /^Material_\d+$/i,
            /^–ú–∞—Ç–µ—Ä–∏–∞–ª\s*\d+$/i,
            /^Material\s*\d+$/i,
            /^GLTF_Material_\d+$/i,
            /^Material$/i,
            /^–ú–∞—Ç–µ—Ä–∏–∞–ª$/i
          ];
          
          const isDefaultName = defaultNamePatterns.some(pattern => pattern.test(materialName));
          if (isDefaultName) {
            console.log(`[ModelViewer] ‚äò GLTF –ú–∞—Ç–µ—Ä–∏–∞–ª "${key}" –ø—Ä–æ–ø—É—â–µ–Ω (–¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∏–º—è): "${materialName}"`);
            return;
          }
          
          console.log(`[ModelViewer] GLTF –ú–∞—Ç–µ—Ä–∏–∞–ª "${key}": name="${materialName}", type="${material.type}"`);
          
          if (!materialsRef.current.has(materialName)) {
            materialsRef.current.set(materialName, material);
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ allMaterials —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø—Ä–∏ –æ–±—Ö–æ–¥–µ —Å—Ü–µ–Ω—ã
            allMaterials.add(materialName);
            if (!materialName.startsWith('__SINGLE__')) {
              materialNames.push(materialName);
              console.log(`[ModelViewer] ‚úì GLTF –ú–∞—Ç–µ—Ä–∏–∞–ª –¥–æ–±–∞–≤–ª–µ–Ω: "${materialName}"`);
            } else {
              console.log(`[ModelViewer] ‚äò GLTF –ú–∞—Ç–µ—Ä–∏–∞–ª –ø—Ä–æ–ø—É—â–µ–Ω (single): "${materialName}"`);
            }
          }
        });
      }
      
      scene.traverse((child) => {
        if (child instanceof THREE.Mesh) {
          console.log(`[ModelViewer] –ù–∞–π–¥–µ–Ω –º–µ—à: ${child.name || 'unnamed'}`);
          
          if (child.material) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∫–∞–∫ –≥–ª—É–±–æ–∫–∏–µ –∫–æ–ø–∏–∏
            const origMat = child.material;
            if (Array.isArray(origMat)) {
              originalMaterialsRef.current.set(child, origMat.map(m => m.clone()));
            } else {
              originalMaterialsRef.current.set(child, origMat.clone());
            }
            
            const materials = Array.isArray(child.material) ? child.material : [child.material];
            console.log(`[ModelViewer] –ú–µ—à –∏–º–µ–µ—Ç ${materials.length} –º–∞—Ç–µ—Ä–∏–∞–ª(–æ–≤)`);
            
            // –°–æ–∑–¥–∞–µ–º Set –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ –º–µ—à–∞
            const meshMaterialNames = new Set<string>();
            
            materials.forEach((mat, index) => {
              // –ü–æ–ª—É—á–∞–µ–º –∏–º—è –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
              let materialName = mat.name || `Material_${index}`;
              let hasRealName = !!mat.name; // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ä–µ–∞–ª—å–Ω–æ–µ –∏–º—è
              
              // –í–ê–ñ–ù–û: –ï—Å–ª–∏ –º–∞—Ç–µ—Ä–∏–∞–ª –Ω–µ –∏–º–µ–µ—Ç –∏–º–µ–Ω–∏, –Ω–æ –±—ã–ª —Å–æ–∑–¥–∞–Ω —Å –∏–º–µ–Ω–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ,
              // –ø–æ–ø—ã—Ç–∞–µ–º—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–º—è –∏–∑ gltfMaterials, —Å—Ä–∞–≤–Ω–∏–≤–∞—è —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ–±—ä–µ–∫—Ç—ã
              if (!hasRealName && gltfMaterials) {
                const gltfMaterialsArray = Array.isArray(gltfMaterials) 
                  ? gltfMaterials 
                  : Object.values(gltfMaterials) as THREE.Material[];
                
                // –ò—â–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª –≤ gltfMaterials –ø–æ —Å—Å—ã–ª–∫–µ –Ω–∞ –æ–±—ä–µ–∫—Ç (—Ç–æ—Ç –∂–µ —ç–∫–∑–µ–º–ø–ª—è—Ä)
                const matchingGltfMaterial = gltfMaterialsArray.find((gltfMat: THREE.Material) => gltfMat === mat);
                
                if (matchingGltfMaterial && matchingGltfMaterial.name && matchingGltfMaterial.name.trim() !== '') {
                  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–º—è –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –∏–∑ gltfMaterials
                  mat.name = matchingGltfMaterial.name;
                  materialName = matchingGltfMaterial.name;
                  hasRealName = true;
                  console.log(`[ModelViewer] ‚úì –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∏–º—è –º–∞—Ç–µ—Ä–∏–∞–ª–∞: "${materialName}" (–∏–∑ gltfMaterials)`);
                }
              }
              
              console.log(`[ModelViewer] –ú–∞—Ç–µ—Ä–∏–∞–ª [${index}]: name="${materialName}", hasRealName=${hasRealName}, type="${mat.type}"`);
              
              // –î–æ–±–∞–≤–ª—è–µ–º –∏–º—è –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –≤ —Å–ø–∏—Å–æ–∫ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ —ç—Ç–æ–≥–æ –º–µ—à–∞ (–¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
              if (hasRealName) {
                meshMaterialNames.add(materialName);
              } else {
                // –î–ª—è –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –±–µ–∑ –∏–º–µ–Ω–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–Ω–¥–µ–∫—Å –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
                meshMaterialNames.add(`__INDEX_${index}__`);
              }
              
              // –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –º–∞—Ç–µ—Ä–∏–∞–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –µ—Å—Ç—å –≤ gltfMaterials
              // –ú–∞—Ç–µ—Ä–∏–∞–ª—ã –±–µ–∑ –∏–º–µ–Ω–∏ (–∏–ª–∏ —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –∏–º–µ–Ω–∞–º–∏) –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –¥–ª—è —Å–ø–∏—Å–∫–∞ –≤—ã–±–æ—Ä–∞
              // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–æ—è–≤–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ —Ç–∏–ø–∞ "Material_0", "Material_1" –∏ —Ç.–¥.
              
              if (!hasRealName) {
                // –ú–∞—Ç–µ—Ä–∏–∞–ª –±–µ–∑ –∏–º–µ–Ω–∏ - –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫ –¥–ª—è –≤—ã–±–æ—Ä–∞
                // –ù–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ –≤ —Ä–µ—Ñ –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
                const tempName = `__TEMP_MATERIAL_${index}__`;
                if (!materialsRef.current.has(tempName)) {
                  materialsRef.current.set(tempName, mat);
                }
                console.log(`[ModelViewer] ‚äò –ú–∞—Ç–µ—Ä–∏–∞–ª –±–µ–∑ –∏–º–µ–Ω–∏ –ø—Ä–æ–ø—É—â–µ–Ω –¥–ª—è —Å–ø–∏—Å–∫–∞ –≤—ã–±–æ—Ä–∞: index=${index}`);
              } else {
                // –ú–∞—Ç–µ—Ä–∏–∞–ª —Å —Ä–µ–∞–ª—å–Ω—ã–º –∏–º–µ–Ω–µ–º
                if (materialsRef.current.has(materialName)) {
                  // –ú–∞—Ç–µ—Ä–∏–∞–ª —É–∂–µ –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω –∏–∑ gltfMaterials - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ
                  console.log(`[ModelViewer] ‚äò –ú–∞—Ç–µ—Ä–∏–∞–ª –∏–∑ –º–µ—à–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–∏–∑ gltfMaterials): "${materialName}"`);
                } else {
                  // –ú–∞—Ç–µ—Ä–∏–∞–ª —Å —Ä–µ–∞–ª—å–Ω—ã–º –∏–º–µ–Ω–µ–º, –Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ gltfMaterials
                  // –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª, —Å–æ–∑–¥–∞–Ω–Ω—ã–π –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∏–ª–∏ –Ω–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π
                  // –î–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –≤ —Ä–µ—Ñ, –Ω–æ –ù–ï –≤ —Å–ø–∏—Å–æ–∫ –¥–ª—è –≤—ã–±–æ—Ä–∞ (–ø–æ–ª–∞–≥–∞–µ–º—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ gltfMaterials)
                  materialsRef.current.set(materialName, mat);
                  console.log(`[ModelViewer] ‚äò –ú–∞—Ç–µ—Ä–∏–∞–ª "${materialName}" –Ω–∞–π–¥–µ–Ω –≤ –º–µ—à–µ, –Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ gltfMaterials - –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫ –≤—ã–±–æ—Ä–∞`);
                  
                  // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ single –º–∞—Ç–µ—Ä–∏–∞–ª –∏ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ —Å–ø–∏—Å–æ–∫, —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –Ω–∏–∂–µ
                  // –ù–æ –ª—É—á—à–µ –ø–æ–ª–∞–≥–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ gltfMaterials
                  /*
                  if (!materialName.startsWith('__SINGLE__') && !allMaterials.has(materialName)) {
                    materialNames.push(materialName);
                    allMaterials.add(materialName);
                    console.log(`[ModelViewer] ‚úì –ú–∞—Ç–µ—Ä–∏–∞–ª –∏–∑ –º–µ—à–∞ –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–ø–∏—Å–æ–∫: "${materialName}"`);
                  }
                  */
                }
              }
            });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ –º–µ—à–∞
            meshMaterialsMap.current.set(child, meshMaterialNames);
            const savedMaterialsStr = Array.from(meshMaterialNames).join(', ') || '–Ω–µ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤';
            console.log(`[ModelViewer] –°–æ—Ö—Ä–∞–Ω–µ–Ω—ã –º–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è –º–µ—à–∞ "${child.name || 'unnamed'}": [${savedMaterialsStr}]`);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∏–∑ gltfMaterials
            const gltfMatNames = gltfMaterials ? (Array.isArray(gltfMaterials) 
              ? gltfMaterials.map(m => m.name).filter(Boolean)
              : Object.values(gltfMaterials).map((m: any) => m.name).filter(Boolean)
            ) : [];
            const matchingMats = Array.from(meshMaterialNames).filter(name => gltfMatNames.includes(name));
            if (matchingMats.length !== meshMaterialNames.size) {
              console.log(`[ModelViewer] ‚ö† –í–Ω–∏–º–∞–Ω–∏–µ: –Ω–µ –≤—Å–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –º–µ—à–∞ –Ω–∞–π–¥–µ–Ω—ã –≤ gltfMaterials. –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: [${savedMaterialsStr}], –≤ GLTF: [${gltfMatNames.join(', ')}]`);
            }
            
            // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º geometry.groups - —Ç–∞–º –º–æ–≥—É—Ç –±—ã—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
            if (child.geometry && child.geometry.groups) {
              console.log(`[ModelViewer] –ú–µ—à –∏–º–µ–µ—Ç ${child.geometry.groups.length} groups`);
              child.geometry.groups.forEach((group: { start: number; count: number; materialIndex?: number }, idx: number) => {
                console.log(`[ModelViewer] Group [${idx}]: materialIndex=${group.materialIndex}, start=${group.start}, count=${group.count}`);
              });
            }
          } else {
            console.log(`[ModelViewer] ‚ö† –ú–µ—à –Ω–µ –∏–º–µ–µ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª–∞`);
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—É—Å—Ç–æ–π Set –¥–ª—è –º–µ—à–µ–π –±–µ–∑ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
            meshMaterialsMap.current.set(child, new Set<string>());
          }
        }
      });
      
      // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º
      const uniqueNames = Array.from(new Set(materialNames)).sort();
      console.log(`[ModelViewer] –ò—Ç–æ–≥–æ –Ω–∞–π–¥–µ–Ω–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤: ${uniqueNames.length}`, uniqueNames);
      
      // –£–≤–µ–¥–æ–º–ª—è–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–∞—Ö
      // –í—ã–∑—ã–≤–∞–µ–º –¥–∞–∂–µ –µ—Å–ª–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –Ω–µ—Ç (–¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è)
      if (onMaterialsFound) {
        onMaterialsFound(uniqueNames);
      }
    }
  }, [scene, onMaterialsFound]);

  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –ø–æ –∏–º–µ–Ω–∏
  useEffect(() => {
    if (!scene) return;
    
    console.log(`[ModelViewer] üîÑ –ù–∞—á–∞–ª–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–∞: "${selectedMaterialName || '–Ω–µ—Ç'}"`);
    console.log(`[ModelViewer] –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã: ${Array.from(materialsRef.current.keys()).join(', ')}`);
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º
    let appliedCount = 0;
    let skippedCount = 0;
    
    scene.traverse((child) => {
      if (child instanceof THREE.Mesh) {
        const originalMaterial = originalMaterialsRef.current.get(child);
        // meshMaterialNames –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –∫–æ–¥–µ –Ω–∏–∂–µ –¥–ª—è –≤–µ—Ä—Å–∏–∏ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∏—Å—Ö–æ–¥–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
        // eslint-disable-next-line @typescript-eslint/no-unused-vars
        const meshMaterialNames = meshMaterialsMap.current.get(child);
        
        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –º–µ—à–∏ –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞
        if (!originalMaterial) {
          console.log(`[ModelViewer] ‚ö† –ú–µ—à "${child.name || 'unnamed'}" –ø—Ä–æ–ø—É—â–µ–Ω - –Ω–µ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞`);
          return;
        }
        
        if (selectedMaterialName && materialsRef.current.has(selectedMaterialName)) {
          const targetMaterial = materialsRef.current.get(selectedMaterialName)!;
          
          // ============================================================================
          // –í–ï–†–°–ò–Ø –î–õ–Ø –î–ò–í–ê–ù–ê: –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª –∫–æ –í–°–ï–ú –º–µ—à–∞–º –º–æ–¥–µ–ª–∏
          // ============================================================================
          // –í–ê–ñ–ù–û: –≠—Ç–∞ –≤–µ—Ä—Å–∏—è –ø—Ä–∏–º–µ–Ω—è–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª –∫–æ –≤—Å–µ–º –º–µ—à–∞–º –º–æ–¥–µ–ª–∏,
          // –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç–æ–≥–æ, –µ—Å—Ç—å –ª–∏ —ç—Ç–æ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª –≤ –∏—Å—Ö–æ–¥–Ω–æ–º —Å–ø–∏—Å–∫–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –º–µ—à–∞.
          // –≠—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –¥–∏–≤–∞–Ω–∞, –≥–¥–µ –º–∞—Ç–µ—Ä–∏–∞–ª –¥–æ–ª–∂–µ–Ω –ø—Ä–∏–º–µ–Ω—è—Ç—å—Å—è –∫–æ –≤—Å–µ–π –º–æ–¥–µ–ª–∏ —Ü–µ–ª–∏–∫–æ–º.
          // 
          // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤–µ—Ä—Å–∏–∏, –≥–¥–µ –º–∞—Ç–µ—Ä–∏–∞–ª –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫ –º–µ—à–∞–º,
          // —É –∫–æ—Ç–æ—Ä—ã—Ö –æ–Ω –±—ã–ª –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ, –Ω—É–∂–Ω–æ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∏–∂–µ.
          // ============================================================================
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π –º–∞—Ç–µ—Ä–∏–∞–ª –º–µ—à–∞ (–¥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è)
          const currentMat = Array.isArray(child.material) ? child.material[0] : child.material;
          const currentMatName = (currentMat as THREE.Material)?.name || '';
          const hasMaterialCurrently = currentMatName === selectedMaterialName;
          
          // –ï—Å–ª–∏ –º–∞—Ç–µ—Ä–∏–∞–ª —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω –∫ –º–µ—à—É, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º (–Ω–µ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
          if (hasMaterialCurrently) {
            console.log(`[ModelViewer] ‚Ñπ –ú–µ—à "${child.name || 'unnamed'}" —É–∂–µ –∏–º–µ–µ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª "${selectedMaterialName}" - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º`);
            return;
          }
          
          // ============================================================================
          // –ó–ê–ö–û–ú–ú–ï–ù–¢–ò–†–û–í–ê–ù–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –∫ –º–µ—à–∞–º —Å –∏—Å—Ö–æ–¥–Ω—ã–º –º–∞—Ç–µ—Ä–∏–∞–ª–æ–º
          // ============================================================================
          // –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –∫–æ–¥ –Ω–∏–∂–µ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø—Ä–∏–º–µ–Ω—è—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª –¢–û–õ–¨–ö–û –∫ –º–µ—à–∞–º,
          // —É –∫–æ—Ç–æ—Ä—ã—Ö —ç—Ç–æ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª –±—ã–ª –≤ –∏—Å—Ö–æ–¥–Ω–æ–º —Å–ø–∏—Å–∫–µ:
          //
          // const hasMaterialInOriginalList = meshMaterialNames ? meshMaterialNames.has(selectedMaterialName) : false;
          // if (!hasMaterialInOriginalList) {
          //   skippedCount++;
          //   console.log(`[ModelViewer] ‚äò –ú–µ—à "${child.name || 'unnamed'}" –ø—Ä–æ–ø—É—â–µ–Ω - –Ω–µ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª–∞ "${selectedMaterialName}" –≤ –∏—Å—Ö–æ–¥–Ω–æ–º —Å–ø–∏—Å–∫–µ`);
          //   return;
          // }
          // ============================================================================
          
          console.log(`[ModelViewer] ‚úì –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª "${selectedMaterialName}" –∫–æ –≤—Å–µ–º—É –º–µ—à—É "${child.name || 'unnamed'}"`);
          
          // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–∞ —Å–æ –≤—Å–µ–º–∏ —Ç–µ–∫—Å—Ç—É—Ä–∞–º–∏
          const cloneMaterialDeep = (mat: THREE.Material): THREE.Material => {
            const cloned = mat.clone();
            cloned.name = selectedMaterialName;
            cloned.needsUpdate = true;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–∞—Ç–µ—Ä–∏–∞–ª –∏–º–µ–µ—Ç —Å–≤–æ–π—Å—Ç–≤–∞ —Ç–µ–∫—Å—Ç—É—Ä (MeshStandardMaterial, MeshPhongMaterial –∏ —Ç.–¥.)
            const sourceMat = mat as any;
            const targetMat = cloned as any;
            
            // –ö–ª–æ–Ω–∏—Ä—É–µ–º –≤—Å–µ —Ç–µ–∫—Å—Ç—É—Ä—ã –º–∞—Ç–µ—Ä–∏–∞–ª–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ç–∏–ø–∏–∑–∞—Ü–∏–µ–π
            if (sourceMat.map instanceof THREE.Texture) {
              targetMat.map = sourceMat.map.clone();
              if (targetMat.map) {
                targetMat.map.needsUpdate = true;
                targetMat.map.updateMatrix();
              }
            }
            if (sourceMat.normalMap instanceof THREE.Texture) {
              targetMat.normalMap = sourceMat.normalMap.clone();
              if (targetMat.normalMap) {
                targetMat.normalMap.needsUpdate = true;
              }
            }
            if (sourceMat.roughnessMap instanceof THREE.Texture) {
              targetMat.roughnessMap = sourceMat.roughnessMap.clone();
              if (targetMat.roughnessMap) {
                targetMat.roughnessMap.needsUpdate = true;
              }
            }
            if (sourceMat.metalnessMap instanceof THREE.Texture) {
              targetMat.metalnessMap = sourceMat.metalnessMap.clone();
              if (targetMat.metalnessMap) {
                targetMat.metalnessMap.needsUpdate = true;
              }
            }
            if (sourceMat.aoMap instanceof THREE.Texture) {
              targetMat.aoMap = sourceMat.aoMap.clone();
              if (targetMat.aoMap) {
                targetMat.aoMap.needsUpdate = true;
              }
            }
            if (sourceMat.emissiveMap instanceof THREE.Texture) {
              targetMat.emissiveMap = sourceMat.emissiveMap.clone();
              if (targetMat.emissiveMap) {
                targetMat.emissiveMap.needsUpdate = true;
              }
            }
            
            return cloned;
          };
          
          // –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª –∫ —ç—Ç–æ–º—É –º–µ—à—É
          const clonedMaterial = cloneMaterialDeep(targetMaterial);
          
          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –±—ã–ª –ª–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª –º–∞—Å—Å–∏–≤–æ–º (multipl-–æ–±—ä–µ–∫—Ç)
          const wasMultipl = Array.isArray(originalMaterial);
          
          if (wasMultipl) {
            // –î–ª—è multipl-–æ–±—ä–µ–∫—Ç–æ–≤: –∑–∞–º–µ–Ω—è–µ–º –í–°–ï –º–∞—Ç–µ—Ä–∏–∞–ª—ã –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π
            child.material = clonedMaterial;
            
            // –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –û–±–Ω–æ–≤–ª—è–µ–º materialIndex –¥–ª—è –í–°–ï–• –≥—Ä–∞–Ω–µ–π –≥–µ–æ–º–µ—Ç—Ä–∏–∏
            if (child.geometry && child.geometry.attributes) {
              // –ï—Å–ª–∏ —É –≥–µ–æ–º–µ—Ç—Ä–∏–∏ –µ—Å—Ç—å groups, –æ–±–Ω–æ–≤–ª—è–µ–º materialIndex –¥–ª—è –≤—Å–µ—Ö –≥—Ä–∞–Ω–µ–π
              if (child.geometry.groups && child.geometry.groups.length > 0) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ groups, —á—Ç–æ–±—ã –æ–Ω–∏ —É–∫–∞–∑—ã–≤–∞–ª–∏ –Ω–∞ –º–∞—Ç–µ—Ä–∏–∞–ª —Å –∏–Ω–¥–µ–∫—Å–æ–º 0
                child.geometry.groups.forEach((group: { start: number; count: number; materialIndex?: number }) => {
                  group.materialIndex = 0;
                });
                console.log(`[ModelViewer] –û–±–Ω–æ–≤–ª–µ–Ω–æ ${child.geometry.groups.length} –≥—Ä—É–ø–ø –≥–µ–æ–º–µ—Ç—Ä–∏–∏ –¥–ª—è –æ–±—ä–µ–∫—Ç–∞ "${child.name || 'unnamed'}"`);
              }
              
              // –ü–æ–º–µ—á–∞–µ–º –≥–µ–æ–º–µ—Ç—Ä–∏—é –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
              child.geometry.needsUpdate = true;
            }
          } else {
            // –û–¥–∏–Ω –º–∞—Ç–µ—Ä–∏–∞–ª (single-–æ–±—ä–µ–∫—Ç) - –ø—Ä–æ—Å—Ç–æ –∑–∞–º–µ–Ω—è–µ–º
            child.material = clonedMaterial;
          }
          
          console.log(`[ModelViewer] ‚úì –ú–∞—Ç–µ—Ä–∏–∞–ª "${selectedMaterialName}" –ø—Ä–∏–º–µ–Ω–µ–Ω –∫ –º–µ—à—É "${child.name || 'unnamed'}", —Ç–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞: ${child.material instanceof THREE.Material ? (child.material as any).type : 'unknown'}`);
          
          appliedCount++;
          
          // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ–º–µ—á–∞–µ–º –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
          if (child.geometry) {
            child.geometry.needsUpdate = true;
            
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≥–µ–æ–º–µ—Ç—Ä–∏—é –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            if (child.geometry.computeBoundingBox) {
              child.geometry.computeBoundingBox();
            }
            if (child.geometry.computeBoundingSphere) {
              child.geometry.computeBoundingSphere();
            }
          }
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª –∏ –≤—Å–µ –µ–≥–æ —Ç–µ–∫—Å—Ç—É—Ä—ã –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ
          const updateMaterialTextures = (mat: THREE.Material) => {
            if (!mat) return;
            
            mat.needsUpdate = true;
            const matAny = mat as any;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Ç–µ–∫—Å—Ç—É—Ä—ã –º–∞—Ç–µ—Ä–∏–∞–ª–∞
            const textureProps = ['map', 'normalMap', 'roughnessMap', 'metalnessMap', 'aoMap', 'emissiveMap', 'bumpMap', 'displacementMap', 'alphaMap', 'lightMap', 'envMap'];
            
            textureProps.forEach(prop => {
              if (matAny[prop] && matAny[prop] instanceof THREE.Texture) {
                const texture = matAny[prop] as THREE.Texture;
                texture.needsUpdate = true;
                texture.updateMatrix();
              }
            });
          };
          
          if (child.material) {
            if (Array.isArray(child.material)) {
              child.material.forEach(updateMaterialTextures);
            } else {
              updateMaterialTextures(child.material);
            }
          }
          
          // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ç—Ä–∏—Ü—É –º–µ—à–∞
          child.updateMatrix();
          child.updateMatrixWorld(true);
          
          // –ü–æ–º–µ—á–∞–µ–º –º–µ—à –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
          child.visible = false;
          child.visible = true;
          
        } else if (!selectedMaterialName) {
          // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª
          if (Array.isArray(originalMaterial)) {
            child.material = originalMaterial.map(m => m.clone());
          } else {
            child.material = (originalMaterial as THREE.Material).clone();
          }
        }
      }
    });
    
    if (selectedMaterialName) {
      console.log(`[ModelViewer] ‚úÖ –ò—Ç–æ–≥–æ: –ø—Ä–∏–º–µ–Ω–µ–Ω–æ –∫ ${appliedCount} –º–µ—à–∞–º, –ø—Ä–æ–ø—É—â–µ–Ω–æ ${skippedCount} –º–µ—à–µ–π`);
      if (appliedCount === 0) {
        console.log(`[ModelViewer] ‚ö† –ú–∞—Ç–µ—Ä–∏–∞–ª "${selectedMaterialName}" –Ω–µ –±—ã–ª –ø—Ä–∏–º–µ–Ω–µ–Ω –Ω–∏ –∫ –æ–¥–Ω–æ–º—É –º–µ—à—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –º–∞—Ç–µ—Ä–∏–∞–ª –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –º–µ—à–∞—Ö.`);
      } else {
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–Ω–¥–µ—Ä –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
        invalidate();
        console.log(`[ModelViewer] üîÑ –†–µ–Ω–¥–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤`);
      }
    }
  }, [scene, selectedMaterialName, invalidate]);

  // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –º–æ–¥–µ–ª–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
  useEffect(() => {
    if (scene) {
      // calculateModelStatistics –ø—Ä–∏–Ω–∏–º–∞–µ—Ç THREE.Object3D (Group –∏–ª–∏ Scene)
      const stats = calculateModelStatistics(scene, animations);
      dispatch(setStatistics(stats));
    }
    // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
    return () => {
      dispatch(setStatistics(null));
    };
  }, [scene, animations, dispatch]);

  // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∞–Ω–∏–º–∞—Ü–∏–π –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
  React.useEffect(() => {
    setAnimations(names);
  }, [names, setAnimations]);

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–≤—É—é –∞–Ω–∏–º–∞—Ü–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
  React.useEffect(() => {
    if (names.length > 0 && !currentAnimation) {
      const firstAnimation = names[0];
      const action = actions[firstAnimation];
      if (action) {
        action.play();
        setCurrentAnimation(firstAnimation);
      }
    }
  }, [actions, names, currentAnimation, setCurrentAnimation]);

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏
  React.useEffect(() => {
    if (currentAnimation && actions[currentAnimation]) {
      // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∞–Ω–∏–º–∞—Ü–∏–∏
      Object.values(actions).forEach(action => {
        if (action) {
          action.stop();
        }
      });
      
      // –ó–∞–ø—É—Å–∫–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∞–Ω–∏–º–∞—Ü–∏—é
      const action = actions[currentAnimation];
      if (action) {
        action.play();
      }
    }
  }, [currentAnimation, actions]);

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞—É–∑—ã/–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
  React.useEffect(() => {
    if (currentAnimation && actions[currentAnimation]) {
      const action = actions[currentAnimation];
      if (action) {
        action.paused = !isPlaying;
      }
    }
  }, [isPlaying, currentAnimation, actions]);

  // –ü–ª–∞–≤–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ –∑–∞ –º—ã—à–∫–æ–π
  useFrame((state) => {
    if (groupRef.current) {
      // –ü–ª–∞–≤–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –ø–æ–∑–∏—Ü–∏–∏
      if (isNodding) {
        const speed = 0.08;
        nodState.current.angle += speed * nodState.current.direction;
        groupRef.current.rotation.x = Math.sin(nodState.current.angle) * 0.5;
        if (nodState.current.angle > Math.PI / 2) {
          nodState.current.direction = -1;
          nodState.current.count++;
        }
        if (nodState.current.angle < 0) {
          nodState.current.direction = 1;
          nodState.current.count++;
        }
        // –î–≤–æ–π–Ω–æ–π –∫–∏–≤–æ–∫ (–¥–≤–µ –ø–∞—Ä—ã –≤–Ω–∏–∑-–≤–≤–µ—Ä—Ö)
        if (nodState.current.count >= nodState.current.target * 2) {
          setIsNodding && setIsNodding(false);
          nodState.current.angle = 0;
          nodState.current.count = 0;
          groupRef.current.rotation.x = mousePosition.y * 0.2;
        }
      } else if (isShaking) {
        const speed = 0.10;
        shakeState.current.angle += speed * shakeState.current.direction;
        groupRef.current.rotation.y = Math.sin(shakeState.current.angle) * 0.7;
        if (shakeState.current.angle > Math.PI / 3) {
          shakeState.current.direction = -1;
          shakeState.current.count++;
        }
        if (shakeState.current.angle < -Math.PI / 3) {
          shakeState.current.direction = 1;
          shakeState.current.count++;
        }
        // –î–≤–æ–π–Ω–æ–µ "–Ω–µ—Ç" (–≤–ª–µ–≤–æ-–≤–ø—Ä–∞–≤–æ)
        if (shakeState.current.count >= shakeState.current.target * 2) {
          setIsShaking && setIsShaking(false);
          shakeState.current.angle = 0;
          shakeState.current.count = 0;
          groupRef.current.rotation.y = 0;
        }
      } else {
        groupRef.current.rotation.x = mousePosition.y * 0.2;
        groupRef.current.rotation.y = 0;
      }
    }
  });

  return (
    <group ref={groupRef} scale={scale} position={position}>
      <primitive object={scene} />
    </group>
  );
}

export default function ModelViewer({ modelPath, scale = 1, position = [0, 0, 0], selectedMaterialName, onMaterialsFound }: ModelViewerProps) {
  const { animations, currentAnimation, isPlaying, handleAnimationChange, handlePlayPause } = useAnimation();
  const { showButtons, toggleButtons, backgroundImage, setBackgroundImage } = useUI();
  const [isNodding, setIsNodding] = useState(false);
  const [isShaking, setIsShaking] = useState(false);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const statistics = useSelector((state: RootState) => state.model.statistics);
  const models = useSelector((state: RootState) => state.model.models);
  const selectedModel = useSelector((state: RootState) => state.model.selectedModel);
  const selectedModelData = models.find(model => model.id === selectedModel);

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–∏–≤–∫–∞
  const handleNod = () => {
    setIsNodding(true);
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ "–Ω–µ—Ç"
  const handleShake = () => {
    setIsShaking(true);
  };


  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ–Ω–æ–≤–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
  const handleBackgroundUpload = () => {
    fileInputRef.current?.click();
  };


  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
  const handleFileChange = (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (file && file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const result = e.target?.result as string;
        setBackgroundImage(result);
      };
      reader.readAsDataURL(file);
    }
  };



  return (
    <div style={{ width: '100%', height: '100vh', position: 'relative' }}>
      <Canvas
        camera={{ position: [0, 0, 5], fov: 75 }}
        style={{ 
          backgroundColor: '#000000',
          backgroundImage: backgroundImage ? `url(${backgroundImage})` : 'none',
          backgroundSize: 'contain',
          backgroundPosition: 'center',
          backgroundRepeat: 'no-repeat',
          backgroundAttachment: 'fixed'
        }}
      >
        <ambientLight intensity={0.5} />
        <directionalLight position={[10, 10, 5]} intensity={1} castShadow />
        <pointLight position={[-10, -10, -5]} intensity={0.5} />
        
        <Suspense fallback={null}>
          <Model 
            modelPath={modelPath} 
            scale={scale} 
            position={position} 
            isNodding={isNodding} 
            setIsNodding={setIsNodding} 
            isShaking={isShaking} 
            setIsShaking={setIsShaking}
            selectedMaterialName={selectedMaterialName}
            onMaterialsFound={onMaterialsFound}
          />
        </Suspense>
        
        <OrbitControls 
          enablePan={true}
          enableZoom={true}
          enableRotate={true}
        />
        
        <Environment preset="sunset" />
      </Canvas>
      
      {/* –°–∫—Ä—ã—Ç—ã–π input –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ */}
      <input
        ref={fileInputRef}
        type="file"
        accept="image/*"
        onChange={handleFileChange}
        style={{ display: 'none' }}
      />
      
      {/* –ö–Ω–æ–ø–∫–∞ –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è/–ø–æ–∫–∞–∑–∞ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ */}
      <button
        className="toggle-buttons-btn"
        style={{
          position: 'fixed',
          top: 20,
          right: 20,
          zIndex: 1002,
          padding: '10px 15px',
          fontSize: '1rem',
          borderRadius: '8px',
          background: 'linear-gradient(90deg, #4a90e2 60%, #1e3c72 100%)',
          color: 'white',
          border: 'none',
          cursor: 'pointer',
          boxShadow: '0 2px 8px rgba(0,0,0,0.2)',
          transition: 'all 0.2s',
        }}
        onClick={toggleButtons}
      >
        {showButtons ? 'üëÅÔ∏è –°–∫—Ä—ã—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ' : 'üëÅÔ∏è‚Äçüó®Ô∏è –ü–æ–∫–∞–∑–∞—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'}
      </button>

      {/* –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –º–æ–¥–µ–ª–∏ */}
      <ModelStatisticsDisplay 
        statistics={statistics} 
        modelName={selectedModelData?.name}
      />

      {/* –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */}
      {showButtons && (
        <>
          <button
            className="nod-btn"
            onClick={handleNod}
          >
            ü§ñ –ö–∏–≤–æ–∫
          </button>
          <button
            className="shake-btn"
            onClick={handleShake}
          >
            üôÖ‚Äç‚ôÇÔ∏è –ù–µ—Ç
          </button>
          
          {/* –ö–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ–Ω–∞ */}
          <button
            className="background-upload-btn"
            style={{
              position: 'fixed',
              bottom: 32,
              left: 350,
              zIndex: 1001,
              padding: '14px 4px',
              fontSize: '1.2rem',
              borderRadius: '10px',
              background: 'linear-gradient(90deg, #ff9a56 60%, #1e3c72 100%)',
              color: 'white',
              border: 'none',
              cursor: 'pointer',
              boxShadow: '0 2px 12px rgba(0,0,0,0.18)',
              transition: 'background 0.2s',
              width: 'fit-content',
            }}
            onClick={handleBackgroundUpload}
          >
            üñºÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ–Ω
          </button>
          
          
          {animations.length > 0 && (
            <AnimationControls
              animations={animations}
              currentAnimation={currentAnimation}
              onAnimationChange={handleAnimationChange}
              isPlaying={isPlaying}
              onPlayPause={handlePlayPause}
            />
          )}
        </>
      )}
    </div>
  );
} 